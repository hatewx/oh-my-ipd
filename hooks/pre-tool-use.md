---
trigger: PreToolUse
description: |
  在工具使用前执行 IPD-OMO 流程检查。
  确保在当前项目状态下，工具使用符合 IPD 流程规范。
---

# PreToolUse Hook - IPD-OMO 流程控制

## 触发条件
此 Hook 在每次工具使用前触发，用于：
1. 检查当前项目状态
2. 验证操作是否符合 IPD 流程
3. 在必要时请求用户确认

## 检查逻辑

### 1. 项目状态检查
```
读取 .claude/project-state.md
↓
检查当前阶段和状态
↓
如果状态异常 → 提示用户
```

### 2. 工具使用合规检查
根据当前阶段，检查工具使用是否合理：

| 当前阶段 | 允许的操作 | 需要确认的操作 |
|---------|-----------|---------------|
| Charter | 文档读取、状态查询 | 代码修改 |
| LLD | 文档读取、状态查询 | 代码修改 |
| 开发 | 代码修改、测试执行 | 架构变更 |
| TR | 代码读取、测试执行 | 代码修改 |
| Release | 只读操作 | 任何修改 |

### 3. 风险提示
在以下情况下提示风险：
- 在 Charter/LLD 阶段直接修改代码
- 在 TR 评审中修改代码
- 绕过 TR 流程直接提交

## 干预策略

### 警告级别
1. **INFO**: 记录日志，不阻止
2. **WARNING**: 提示用户，不阻止
3. **BLOCKING**: 要求用户确认，可阻止

### 具体场景

#### 场景 1: Charter 阶段修改代码
```
[WARNING] 当前处于 Charter 阶段，不建议直接修改代码。
建议先完成 Charter 定义，再进入开发阶段。

选项:
1. 继续修改 (不推荐)
2. 先完成 Charter
3. 查看项目状态
```

#### 场景 2: Developer 未提交 TR 就请求评审
```
[WARNING] Developer 尚未提交当前实现到 TR。
建议先完成自测，然后使用 `ipd-tr start` 提交评审。

选项:
1. 继续当前操作
2. 提交到 TR
3. 查看 TR 状态
```

#### 场景 3: Token 消耗预警
```
[WARNING] Token 消耗已超过 80% 预算。
建议 LPDT 评估是否继续或调整策略。

选项:
1. 继续 (监控中)
2. 查看资源消耗
3. 请求 LPDT 决策
```

## 输出格式

### 状态提示
```
╔════════════════════════════════════════════════════════════╗
║  IPD-OMO 流程提示                                          ║
╠════════════════════════════════════════════════════════════╣
║  当前阶段: [phase]                                         ║
║  当前状态: [status]                                        ║
║  正在执行: [tool_name]                                     ║
╠════════════════════════════════════════════════════════════╣
║  [提示信息]                                                ║
╚════════════════════════════════════════════════════════════╝
```

## 执行指令

请检查当前工具使用是否符合 IPD-OMO 流程规范，如果不符合则给出相应提示。

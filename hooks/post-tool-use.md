---
trigger: PostToolUse
description: |
  在工具使用后更新 IPD-OMO 项目状态。
  记录操作历史，更新资源消耗，触发必要的后续动作。
---

# PostToolUse Hook - IPD-OMO 状态更新

## 触发条件
此 Hook 在每次工具使用后触发，用于：
1. 记录操作历史
2. 更新项目状态
3. 触发后续自动化流程

## 更新逻辑

### 1. 操作记录
记录工具使用信息：
```yaml
tool_use:
  tool: [tool_name]
  timestamp: [timestamp]
  duration: [duration]
  result: [success/failure]
  agent: [current_agent]
```

### 2. 状态更新
根据工具使用结果更新状态：

#### 如果是 Developer 提交代码
```
更新 Developer 状态: "代码已提交，等待 TR"
触发 PQA 检查
更新 project-state.md
```

#### 如果是 PQA 完成检查
```
更新 PQA 状态: "检查完成"
如果通过 → 触发 TMM 测试
如果失败 → 通知 Developer 修复
```

#### 如果是 TR 完成
```
更新 TR 记录
更新项目阶段（如果通过）
通知 LPDT 决策
```

### 3. 资源消耗更新
更新 Token 消耗统计：
```
读取当前消耗
累加本次消耗
检查是否超过阈值
如果超过 → 触发预警
```

## 自动化触发

### 触发条件与动作

| 前置条件 | 触发动作 |
|---------|---------|
| Developer 提交完成 | 自动触发 PQA 检查 |
| PQA 检查通过 | 自动触发 TMM 测试 |
| TMM 测试通过 | 自动触发 SE 评审 |
| SE 评审通过 | 自动触发 PDU 验证 |
| PDU 验证通过 | 自动触发 LPDT 决策 |
| LPDT 决策 PASS | 自动进入下一阶段 |
| LPDT 决策 FAIL | 自动返回 Developer |

### 异步执行
部分动作可以异步执行：
- 代码分析
- 测试运行
- 文档生成

## 状态同步

### 实时同步
需要立即同步的状态：
- 当前操作者
- 当前阶段
- 阻塞状态

### 延迟同步
可以批量同步的状态：
- 资源消耗
- 历史记录
- 统计数据

## 通知机制

### 通知类型
1. **进度通知**: 阶段完成、TR 通过
2. **阻塞通知**: 需要用户决策、资源耗尽
3. **预警通知**: Token 接近阈值、时间超限
4. **求助通知**: Agent 需要帮助

### 通知格式
```
╔════════════════════════════════════════════════════════════╗
║  IPD-OMO 状态更新                                          ║
╠════════════════════════════════════════════════════════════╣
║  事件: [event_type]                                        ║
║  时间: [timestamp]                                         ║
║  角色: [agent]                                             ║
╠════════════════════════════════════════════════════════════╣
║  [详细信息]                                                ║
╠════════════════════════════════════════════════════════════╣
║  下一步: [suggestion]                                      ║
╚════════════════════════════════════════════════════════════╝
```

## 执行指令

请根据刚执行的工具使用情况，更新 IPD-OMO 项目状态，并触发必要的后续动作。

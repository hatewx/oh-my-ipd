---
name: ipd-tr
description: |
  执行 TR (Technical Review) Dry Run 流程。
  协调 PQA、TMM、SE、PDU 进行代码评审，LPDT 做出最终决策。
arguments:
  - name: action
    description: 操作 (start/retry/status)
    required: true
  - name: iteration
    description: 迭代编号 (用于 retry)
    required: false
---

# TR Dry Run Loop 执行

TR Dry Run 是 IPD-OMO 的核心流程，负责质量门禁和持续改进。

## 流程图

```
Developer 提交
      │
      ▼
┌─────────────┐
│  PQA 检查   │──── Fail ────┐
│  (质量门禁) │              │
└──────┬──────┘              │
      │ Pass                │
      ▼                     │
┌─────────────┐             │
│  TMM 测试   │──── Fail ────┤
│  (功能验证) │              │
└──────┬──────┘              │
      │ Pass                │
      ▼                     │
┌─────────────┐             │
│  SE 评审    │──── Fail ────┤
│  (架构评审) │              │
└──────┬──────┘              │
      │ Pass                │
      ▼                     │
┌─────────────┐             │
│  PDU 验证   │──── Fail ────┘
│  (需求验证) │    (返回 Developer)
└──────┬──────┘
      │ Pass
      ▼
┌─────────────┐
│  LPDT 决策  │──── Pass ────▶ Release
│  (最终裁决) │
└─────────────┘──── Escalate ─▶ 用户决策
```

## 操作模式

### action=start: 开始新的 TR
1. 检查 Developer 是否提交了实现
2. 按顺序激活 PQA → TMM → SE → PDU 进行评审
3. 收集各角色的评审结果
4. LPDT 综合评估并做出决策
5. 更新项目状态

### action=retry: 重新提交修复
1. Developer 修复上一轮的问题
2. 更新迭代计数
3. 重新执行 TR 流程

### action=status: 查看当前 TR 状态
1. 显示当前 TR 进度
2. 显示各角色评审状态
3. 显示阻塞点和历史

## 执行细节

### PQA 检查阶段
激活 `pqa` Agent，执行：
- 流程合规检查
- 代码规范检查 (Lint)
- 质量门禁检查
- 输出质量报告

### TMM 测试阶段
激活 `tmm` Agent，执行：
- 端到端测试
- 边界条件测试
- 错误处理测试
- 输出测试报告

### SE 评审阶段
激活 `se` Agent，执行：
- 架构符合性检查
- 设计模式检查
- 技术债务检查
- 输出架构评审报告

### PDU 验证阶段
激活 `pdu` Agent，执行：
- 需求符合度检查
- 商业逻辑检查
- 用户场景验证
- 输出需求验证报告

### LPDT 决策阶段
作为 LPDT，综合评估：
- 所有评审结果
- 迭代次数
- Token 消耗
- 风险等级

决策选项：
- **PASS**: 进入下一阶段或 Release
- **FAIL**: 返回 Developer 修复
- **ESCALATE**: 请求用户介入

## 输出格式

### TR 执行报告
```
╔════════════════════════════════════════════════════════════╗
║  TR Dry Run Report - Iteration [N]                         ║
╠════════════════════════════════════════════════════════════╣
║  提交时间: [timestamp]                                     ║
║  Developer: [状态]                                         ║
╠════════════════════════════════════════════════════════════╣
║  评审结果                                                  ║
║  ├─ PQA:  [✅/❌] [评分] [问题数]                          ║
║  ├─ TMM:  [✅/❌] [通过率] [缺陷数]                        ║
║  ├─ SE:   [✅/❌] [符合度] [问题数]                        ║
║  └─ PDU:  [✅/❌] [符合度] [偏离项]                        ║
╠════════════════════════════════════════════════════════════╣
║  LPDT 决策: [PASS/FAIL/ESCALATE]                           ║
║  决策理由: [理由]                                          ║
╠════════════════════════════════════════════════════════════╣
║  下一步                                                    ║
║  • [具体行动]                                              ║
╚════════════════════════════════════════════════════════════╝
```

## 执行指令

根据 action 参数执行相应的 TR 流程操作。
